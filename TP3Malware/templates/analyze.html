{% extends "base.html" %}

{% block title %}Analyse Email - {{ email.subject }}{% endblock %}

{% block extra_css %}
<style>
.analyze-container {
    max-width: 1000px;
    margin: 0 auto;
}

.email-summary {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border-left: 4px solid #007bff;
}

.quiz-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    padding: 2rem;
    margin-bottom: 2rem;
}

.question {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #28a745;
}

.question h3 {
    color: #333;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.question-number {
    background: #007bff;
    color: white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
}

.options {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 1rem;
}

.option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.option:hover {
    border-color: #007bff;
    background: #f8f9fa;
}

.option.selected {
    border-color: #007bff;
    background: #e3f2fd;
}

.option input[type="radio"] {
    transform: scale(1.2);
    accent-color: #007bff;
}

.option label {
    flex: 1;
    cursor: pointer;
    font-weight: 500;
}

.submit-section {
    text-align: center;
    margin-top: 2rem;
}

.results-section {
    display: none;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    padding: 2rem;
    margin-top: 2rem;
}

.score-display {
    text-align: center;
    padding: 2rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    color: white;
    margin-bottom: 2rem;
}

.score-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    font-size: 2rem;
    font-weight: bold;
}

.explanation {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.explanation h4 {
    color: #333;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.correct {
    border-left: 4px solid #28a745;
    background: #d4edda;
}

.incorrect {
    border-left: 4px solid #dc3545;
    background: #f8d7da;
}

.red-flags {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 2rem;
}

.red-flags h3 {
    color: #856404;
    margin-bottom: 1rem;
}

.red-flags ul {
    list-style: none;
    padding: 0;
}

.red-flags li {
    padding: 0.5rem 0;
    border-bottom: 1px solid #ffeaa7;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.red-flags li:last-child {
    border-bottom: none;
}

.red-flags li::before {
    content: "⚠️";
    font-size: 1.2rem;
}

.difficulty-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
    margin-left: 1rem;
}

.difficulty-facile {
    background: #d4edda;
    color: #155724;
}

.difficulty-moyen {
    background: #fff3cd;
    color: #856404;
}

.difficulty-difficile {
    background: #f8d7da;
    color: #721c24;
}

.back-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
}

/* Styles pour l'affichage de l'email de référence */
.email-reference {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
    overflow: hidden;
    border: 2px solid #007bff;
}

.email-content-display {
    background: white;
}

.email-header-display {
    background: #f8f9fa;
    padding: 1.5rem;
    border-bottom: 1px solid #e9ecef;
}

.email-meta-display {
    margin-bottom: 1.5rem;
}

.email-subject-display {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.email-subject-display h1 {
    font-size: 1.3rem;
    color: #333;
    margin: 0;
    flex: 1;
}

.phishing-indicator-display {
    background: #dc3545;
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    animation: pulse 2s infinite;
}

.email-info-display {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sender-info-display {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.sender-avatar-display {
    font-size: 2rem;
    color: #6c757d;
}

.sender-details-display {
    line-height: 1.4;
}

.sender-name-display {
    font-weight: 600;
    color: #333;
    font-size: 1rem;
}

.sender-email-display {
    color: #6c757d;
    font-size: 0.9rem;
    font-family: 'Courier New', monospace;
    background: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    margin: 0.2rem 0;
}

.email-date-display {
    color: #6c757d;
    font-size: 0.9rem;
}

.email-body-display {
    padding: 2rem;
    background: white;
}

.email-text-display {
    font-size: 1rem;
    line-height: 1.7;
    color: #333;
}

.email-text-display a {
    color: #007bff;
    text-decoration: underline;
    cursor: pointer;
    position: relative;
    transition: all 0.3s ease;
}

.email-text-display a:hover {
    background: #fff3cd;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    text-decoration: none;
}

/* Indicateurs visuels pour les liens suspects */
.email-text-display a[href*="malicious"],
.email-text-display a[href*="phishing"],
.email-text-display a[href*="fake"] {
    background: linear-gradient(90deg, #dc3545, #fd7e14);
    background-size: 200% 200%;
    animation: suspiciousGradient 3s ease infinite;
    color: white !important;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    text-decoration: none;
    border: 2px dashed #fff;
}

.email-text-display strong {
    color: #333;
    font-weight: 600;
}

.email-text-display small {
    color: #6c757d;
    font-size: 0.85rem;
}

.analysis-tips-inline {
    background: #e3f2fd;
    padding: 1.5rem;
    border-top: 1px solid #e9ecef;
}

.analysis-tips-inline h4 {
    color: #0277bd;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.tips-grid-inline {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.tip-inline {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: white;
    border-radius: 6px;
    border-left: 3px solid #0277bd;
    font-size: 0.9rem;
}

.tip-inline i {
    color: #0277bd;
    width: 16px;
}

/* Animation pour les liens suspects */
@keyframes suspiciousGradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* Responsive Design */
@media (max-width: 768px) {
    .analyze-container {
        padding: 1rem;
    }
    
    .question {
        padding: 1rem;
    }
    
    .option {
        padding: 0.75rem;
    }
    
    .back-actions {
        flex-direction: column;
        align-items: center;
    }
    
    .email-subject-display {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .email-info-display {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .sender-info-display {
        flex-direction: column;
        text-align: center;
    }
    
    .tips-grid-inline {
        grid-template-columns: 1fr;
    }
    
    .email-text-display {
        font-size: 0.95rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="analyze-container">
    <div class="email-summary">
        <h2>
            <i class="fas fa-microscope"></i> 
            Analyse de l'email : {{ email.subject }}
            <span class="difficulty-badge difficulty-{{ email.difficulty }}">
                {{ email.difficulty.title() }}
            </span>
        </h2>
        <p><strong>De :</strong> {{ email.from_display }} &lt;{{ email.from }}&gt;</p>
        <p><strong>Date :</strong> {{ email.date }}</p>
        <p><strong>Client :</strong> {{ client.title() }}</p>
    </div>
    
    <!-- Email complet affiché pour référence -->
    <div class="email-reference">
        <div class="email-content-display">
            <div class="email-header-display">
                <div class="email-meta-display">
                    <div class="email-subject-display">
                        <h1>{{ email.subject }}</h1>
                        {% if email.is_phishing %}
                        <span class="phishing-indicator-display" title="Cet email est une tentative de phishing">
                            <i class="fas fa-exclamation-triangle"></i>
                            Email suspect
                        </span>
                        {% endif %}
                    </div>
                    
                    <div class="email-info-display">
                        <div class="sender-info-display">
                            <div class="sender-avatar-display">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <div class="sender-details-display">
                                <div class="sender-name-display">{{ email.from_display }}</div>
                                <div class="sender-email-display">{{ email.from }}</div>
                                <div class="email-date-display">{{ email.date }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="email-body-display">
                <div class="email-text-display">
                    {{ email.content|safe }}
                </div>
            </div>
        </div>
        
        <div class="analysis-tips-inline">
            <h4><i class="fas fa-lightbulb"></i> Conseils d'analyse</h4>
            <div class="tips-grid-inline">
                <div class="tip-inline">
                    <i class="fas fa-envelope"></i>
                    <strong>Expéditeur :</strong> Vérifiez l'adresse email et le nom affiché
                </div>
                <div class="tip-inline">
                    <i class="fas fa-link"></i>
                    <strong>Liens :</strong> Survolez les liens pour voir leur vraie destination
                </div>
                <div class="tip-inline">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Urgence :</strong> Méfiez-vous des messages urgents ou menaçants
                </div>
                <div class="tip-inline">
                    <i class="fas fa-spell-check"></i>
                    <strong>Contenu :</strong> Cherchez les fautes d'orthographe et de grammaire
                </div>
            </div>
        </div>
    </div>
    
    <div class="quiz-section">
        <h2><i class="fas fa-question-circle"></i> Quiz d'Analyse</h2>
        <p>Répondez aux questions suivantes pour tester vos capacités de détection du phishing :</p>
        
        <form id="analysisForm">
            <input type="hidden" name="email_id" value="{{ email.id }}">
            
            <div class="question">
                <h3>
                    <span class="question-number">1</span>
                    Cet email vous semble-t-il suspect ?
                </h3>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="is_phishing" value="true" id="phishing_yes">
                        <label for="phishing_yes">Oui, c'est un email de phishing</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="is_phishing" value="false" id="phishing_no">
                        <label for="phishing_no">Non, c'est un email légitime</label>
                    </div>
                </div>
            </div>
            
            <div class="question">
                <h3>
                    <span class="question-number">2</span>
                    L'expéditeur vous semble-t-il fiable ?
                </h3>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="sender_suspicious" value="true" id="sender_sus">
                        <label for="sender_sus">Non, l'expéditeur est suspect</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="sender_suspicious" value="false" id="sender_ok">
                        <label for="sender_ok">Oui, l'expéditeur semble légitime</label>
                    </div>
                </div>
            </div>
            
            <div class="question">
                <h3>
                    <span class="question-number">3</span>
                    Le message contient-il des éléments d'urgence suspects ?
                </h3>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="urgency_suspicious" value="true" id="urgency_yes">
                        <label for="urgency_yes">Oui, il y a une urgence artificielle</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="urgency_suspicious" value="false" id="urgency_no">
                        <label for="urgency_no">Non, pas d'urgence suspecte</label>
                    </div>
                </div>
            </div>
            
            <div class="question">
                <h3>
                    <span class="question-number">4</span>
                    Les liens dans l'email vous semblent-ils suspects ?
                </h3>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="link_suspicious" value="true" id="link_sus">
                        <label for="link_sus">Oui, les liens sont suspects</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="link_suspicious" value="false" id="link_ok">
                        <label for="link_ok">Non, les liens semblent légitimes</label>
                    </div>
                </div>
            </div>
            
            {% if email.difficulty == 'facile' %}
            <div class="question">
                <h3>
                    <span class="question-number">5</span>
                    Cet email propose-t-il quelque chose de non sollicité ?
                </h3>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="unsolicited_offer" value="true" id="unsolicited_yes">
                        <label for="unsolicited_yes">Oui, offre non sollicitée</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="unsolicited_offer" value="false" id="unsolicited_no">
                        <label for="unsolicited_no">Non, pas d'offre suspecte</label>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if email.difficulty == 'moyen' %}
            <div class="question">
                <h3>
                    <span class="question-number">5</span>
                    L'email contient-il des pièces jointes suspectes ?
                </h3>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="attachment_suspicious" value="true" id="attachment_sus">
                        <label for="attachment_sus">Oui, pièces jointes suspectes</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="attachment_suspicious" value="false" id="attachment_ok">
                        <label for="attachment_ok">Non, pas de pièces jointes suspectes</label>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="submit-section">
                <button type="submit" class="btn btn-primary" style="font-size: 1.1rem; padding: 1rem 2rem;">
                    <i class="fas fa-check-circle"></i> Soumettre mon analyse
                </button>
            </div>
        </form>
    </div>
    
    <div class="results-section" id="resultsSection">
        <div class="score-display">
            <div>
                <div class="score-circle" id="scoreCircle">
                    <span id="scoreText">0%</span>
                </div>
                <h3>Votre Score de Détection</h3>
                <p id="scoreDescription">Analyse en cours...</p>
            </div>
        </div>
        
        <div id="explanations">
            <!-- Les explications seront ajoutées dynamiquement -->
        </div>
        
        <div class="red-flags">
            <h3><i class="fas fa-flag"></i> Indices de Phishing dans cet Email</h3>
            <ul>
                {% for flag in email.red_flags %}
                <li>{{ flag }}</li>
                {% endfor %}
            </ul>
        </div>
        
        <div class="back-actions">
            <a href="{{ url_for('view_email', email_id=email.id) }}?client={{ client }}" class="btn btn-primary">
                <i class="fas fa-arrow-left"></i> Retour à l'email
            </a>
            <a href="{{ url_for('gmail') if client == 'gmail' else url_for('outlook') }}" class="btn btn-success">
                <i class="fas fa-inbox"></i> Retour à la boîte de réception
            </a>
            <a href="{{ url_for('results') }}" class="btn btn-secondary">
                <i class="fas fa-chart-bar"></i> Voir tous mes résultats
            </a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('analysisForm');
    const resultsSection = document.getElementById('resultsSection');
    
    // Gestion de la sélection des options
    document.querySelectorAll('.option').forEach(option => {
        option.addEventListener('click', function() {
            const radio = this.querySelector('input[type="radio"]');
            const name = radio.name;
            
            // Désélectionner les autres options du même groupe
            document.querySelectorAll(`input[name="${name}"]`).forEach(input => {
                input.closest('.option').classList.remove('selected');
            });
            
            // Sélectionner cette option
            radio.checked = true;
            this.classList.add('selected');
        });
    });
    
    // Soumission du formulaire
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Vérifier que toutes les questions ont une réponse
        const questions = ['is_phishing', 'sender_suspicious', 'urgency_suspicious', 'link_suspicious'];
        const answers = {};
        let allAnswered = true;
        
        questions.forEach(function(question) {
            const selectedOption = document.querySelector(`input[name="${question}"]:checked`);
            if (selectedOption) {
                answers[question] = selectedOption.value === 'true';
                console.log(`Question ${question}: ${selectedOption.value} -> ${answers[question]}`);
            } else {
                console.log(`Question ${question}: PAS DE RÉPONSE`);
                allAnswered = false;
            }
        });
        
        // Ajouter les questions optionnelles selon la difficulté
        const difficultyQuestions = {
            'facile': ['unsolicited_offer'],
            'moyen': ['attachment_suspicious']
        };
        
        // Déterminer la difficulté de l'email actuel
        const emailDifficulty = '{{ email.difficulty }}';
        if (difficultyQuestions[emailDifficulty]) {
            difficultyQuestions[emailDifficulty].forEach(function(question) {
                const selectedOption = document.querySelector(`input[name="${question}"]:checked`);
                if (selectedOption) {
                    answers[question] = selectedOption.value === 'true';
                    console.log(`Question bonus ${question}: ${selectedOption.value} -> ${answers[question]}`);
                }
            });
        }
        
        if (!allAnswered) {
            alert('Veuillez répondre à toutes les questions avant de soumettre.');
            return;
        }
        
        const formData = new FormData(form);
        const emailId = formData.get('email_id');
        
        // Debug: Afficher les réponses dans la console
        console.log('Réponses envoyées:', answers);
        console.log('Email ID:', emailId);
        console.log('Nombre de réponses:', Object.keys(answers).length);
        
        // Envoyer les réponses au serveur
        fetch('/submit_analysis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email_id: parseInt(emailId),
                answers: answers
            })
        })
        .then(response => response.json())
        .then(data => {
            displayResults(data);
            
            // Marquer l'email comme complété dans le localStorage
            console.log('Données reçues du serveur complètes:', data);
            
            // Forcer la sauvegarde même si email_completed n'est pas présent
            let completedEmails = JSON.parse(localStorage.getItem('completedEmails') || '[]');
            const emailIdStr = emailId.toString();
            
            console.log('Sauvegarde email complété:', {
                emailId: emailIdStr,
                emailIdType: typeof emailIdStr,
                completedEmails,
                alreadyExists: completedEmails.includes(emailIdStr)
            });
            
            if (!completedEmails.includes(emailIdStr)) {
                completedEmails.push(emailIdStr);
                localStorage.setItem('completedEmails', JSON.stringify(completedEmails));
                console.log('Email sauvegardé, nouveau localStorage:', completedEmails);
            } else {
                console.log('Email déjà dans la liste');
            }
            
            // Vérification de la sauvegarde
            const savedEmails = JSON.parse(localStorage.getItem('completedEmails') || '[]');
            console.log('Vérification sauvegarde finale:', savedEmails);
            
            // Test direct du localStorage
            console.log('Test direct localStorage:', localStorage.getItem('completedEmails'));
            
            // Test immédiat pour vérifier si localStorage fonctionne
            try {
                localStorage.setItem('test', 'valeur-test');
                const testValue = localStorage.getItem('test');
                console.log('Test localStorage général:', testValue);
                localStorage.removeItem('test');
                
                if (testValue === 'valeur-test') {
                    console.log('✅ localStorage fonctionne correctement');
                } else {
                    console.log('❌ localStorage ne fonctionne pas');
                }
            } catch (e) {
                console.log('❌ Erreur localStorage:', e);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors de l\'analyse.');
        });
    });
    
    function displayResults(data) {
        const scoreText = document.getElementById('scoreText');
        const scoreDescription = document.getElementById('scoreDescription');
        const explanations = document.getElementById('explanations');
        
        // Afficher le score
        scoreText.textContent = data.percentage + '%';
        
        let description = '';
        if (data.percentage >= 80) {
            description = 'Excellent ! Vous avez un bon œil pour détecter le phishing.';
        } else if (data.percentage >= 60) {
            description = 'Bien ! Vous identifiez la plupart des indices suspects.';
        } else if (data.percentage >= 40) {
            description = 'Moyen. Vous pourriez améliorer votre détection.';
        } else {
            description = 'Attention ! Vous devez être plus vigilant face au phishing.';
        }
        
        scoreDescription.textContent = description;
        
        // Afficher les explications
        explanations.innerHTML = '';
        
        // Mapping précis des questions avec leurs clés
        const questionMapping = {
            'is_phishing': 'Cet email vous semble-t-il suspect ?',
            'sender_suspicious': 'L\'expéditeur vous semble-t-il fiable ?',
            'urgency_suspicious': 'Le message contient-il des éléments d\'urgence suspects ?',
            'link_suspicious': 'Les liens dans l\'email vous semblent-ils suspects ?',
            'unsolicited_offer': 'Cet email propose-t-il quelque chose de non sollicité ?',
            'attachment_suspicious': 'L\'email contient-il des pièces jointes suspectes ?'
        };
        
        // Mapping des réponses en français
        const answerMapping = {
            'is_phishing': {
                true: 'Oui, c\'est un email de phishing',
                false: 'Non, c\'est un email légitime'
            },
            'sender_suspicious': {
                true: 'Non, l\'expéditeur est suspect',
                false: 'Oui, l\'expéditeur semble légitime'
            },
            'urgency_suspicious': {
                true: 'Oui, il y a une urgence artificielle',
                false: 'Non, pas d\'urgence suspecte'
            },
            'link_suspicious': {
                true: 'Oui, les liens sont suspects',
                false: 'Non, les liens semblent légitimes'
            },
            'unsolicited_offer': {
                true: 'Oui, offre non sollicitée',
                false: 'Non, pas d\'offre suspecte'
            },
            'attachment_suspicious': {
                true: 'Oui, pièces jointes suspectes',
                false: 'Non, pas de pièces jointes suspectes'
            }
        };
        
        // Debug: Afficher les données reçues
        console.log('Données reçues du serveur:', data);
        console.log('Réponses correctes:', data.correct_answers);
        console.log('Réponses utilisateur:', data.user_answers);
        
        for (let [questionKey, correctAnswer] of Object.entries(data.correct_answers)) {
            const userAnswer = data.user_answers[questionKey];
            const isCorrect = userAnswer === correctAnswer;
            const questionText = questionMapping[questionKey] || questionKey;
            
            // Debug: Afficher chaque comparaison
            console.log(`Question: ${questionKey}`);
            console.log(`Réponse utilisateur: ${userAnswer} (type: ${typeof userAnswer})`);
            console.log(`Réponse correcte: ${correctAnswer} (type: ${typeof correctAnswer})`);
            console.log(`Correct: ${isCorrect}`);
            
            const explanationDiv = document.createElement('div');
            explanationDiv.className = `explanation ${isCorrect ? 'correct' : 'incorrect'}`;
            
            // Utiliser le mapping français pour les réponses
            const userAnswerText = answerMapping[questionKey] ? 
                answerMapping[questionKey][userAnswer] : 
                (userAnswer ? 'Oui' : 'Non');
            
            const correctAnswerText = answerMapping[questionKey] ? 
                answerMapping[questionKey][correctAnswer] : 
                (correctAnswer ? 'Oui' : 'Non');
            
            explanationDiv.innerHTML = `
                <h4>
                    <i class="fas fa-${isCorrect ? 'check-circle' : 'times-circle'}"></i>
                    ${questionText}
                </h4>
                <p>
                    <strong>Votre réponse :</strong> ${userAnswerText}<br>
                    <strong>Bonne réponse :</strong> ${correctAnswerText}
                    ${isCorrect ? ' ✓' : ' ✗'}
                </p>
            `;
            
            explanations.appendChild(explanationDiv);
        }
        
        // Afficher la section des résultats
        resultsSection.style.display = 'block';
        
        // Scroll vers les résultats
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }
});
</script>
{% endblock %}