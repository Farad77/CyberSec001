{% extends "base.html" %}

{% block title %}{{ email.subject }} - TP Phishing{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/email_detail.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="email-container">
    <div class="email-header">
        <div class="back-button">
            <a href="{{ url_for('gmail') if client == 'gmail' else url_for('outlook') }}" class="btn btn-primary">
                <i class="fas fa-arrow-left"></i> Retour √† la bo√Æte de r√©ception
            </a>
        </div>
        <div class="email-actions">
            <button class="btn btn-danger" onclick="analyzeEmail()">
                <i class="fas fa-search"></i> Analyser cet email
            </button>
        </div>
    </div>
    
    <div class="email-content">
        <div class="email-meta">
            <div class="email-subject">
                <h1>{{ email.subject }}</h1>
                {% if email.is_phishing %}
                <span class="phishing-indicator" title="Cet email est une tentative de phishing">
                    <i class="fas fa-exclamation-triangle"></i>
                    Email suspect
                </span>
                {% endif %}
            </div>
            
            <div class="email-info">
                <div class="sender-info">
                    <div class="sender-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="sender-details">
                        <div class="sender-name">{{ email.from_display }}</div>
                        <div class="sender-email">{{ email.from }}</div>
                        <div class="email-date">{{ email.date }}</div>
                    </div>
                </div>
                
                <div class="email-actions-small">
                    <i class="fas fa-reply" title="R√©pondre"></i>
                    <i class="fas fa-forward" title="Transf√©rer"></i>
                    <i class="fas fa-trash" title="Supprimer"></i>
                    <i class="fas fa-exclamation-triangle" title="Signaler comme spam"></i>
                </div>
            </div>
        </div>
        
        <div class="email-body">
            <div class="email-text">
                {{ email.content|safe }}
            </div>
            
            {% if email.attachments %}
            <div class="email-attachments">
                <h3><i class="fas fa-paperclip"></i> Pi√®ces jointes ({{ email.attachments|length }})</h3>
                <div class="attachments-list">
                    {% for attachment in email.attachments %}
                    <div class="attachment-item">
                        <div class="attachment-icon">
                            <i class="fas fa-file"></i>
                        </div>
                        <div class="attachment-info">
                            <div class="attachment-name">
                                <a href="{{ attachment.url }}" 
                                   class="attachment-link"
                                   target="_blank" rel="noopener"
                                   download="{{ attachment.name }}">
                                    {{ attachment.name }}
                                </a>
                            </div>
                            <div class="attachment-size">{{ attachment.size }}</div>
                        </div>
                        <div class="attachment-actions">
                            <button class="btn-attachment download" 
                                    onclick="downloadAttachment('{{ attachment.url }}', '{{ attachment.name }}')">
                                <i class="fas fa-download"></i> T√©l√©charger
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="analysis-tips">
        <div class="card">
            <h3><i class="fas fa-lightbulb"></i> Conseils d'analyse</h3>
            <div class="tips-grid">
                <div class="tip">
                    <i class="fas fa-envelope"></i>
                    <strong>Exp√©diteur :</strong> V√©rifiez l'adresse email et le nom affich√©
                </div>
                <div class="tip">
                    <i class="fas fa-link"></i>
                    <strong>Liens :</strong> Survolez les liens pour voir leur vraie destination
                </div>
                <div class="tip">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Urgence :</strong> M√©fiez-vous des messages urgents ou mena√ßants
                </div>
                <div class="tip">
                    <i class="fas fa-spell-check"></i>
                    <strong>Contenu :</strong> Cherchez les fautes d'orthographe et de grammaire
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function analyzeEmail() {
    window.location.href = `/analyze/{{ email.id }}?client={{ client }}`;
}

function confirmDownload(filename, url, isSuspicious) {
    if (isSuspicious) {
        const confirmed = confirm(
            '‚ö†Ô∏è ATTENTION S√âCURIT√â ‚ö†Ô∏è\n\n' +
            'Ce fichier est potentiellement dangereux !\n\n' +
            `Fichier: ${filename}\n` +
            `URL: ${url}\n\n` +
            '√ätes-vous s√ªr de vouloir le t√©l√©charger ?\n\n' +
            '‚ö†Ô∏è NE PAS EX√âCUTER ce fichier sur un syst√®me de production !'
        );
        
        if (confirmed) {
            // Log pour formation
            console.log(`üö® T√âL√âCHARGEMENT DANGEREUX: ${filename} depuis ${url}`);
            alert('üí° Formation: Dans un vrai environnement, ce fichier pourrait infecter votre syst√®me !');
        }
        
        return confirmed;
    } else {
        return confirm(`T√©l√©charger ${filename} ?`);
    }
}

function downloadAttachment(url, filename) {
    // D√©clenche un t√©l√©chargement direct (nouvel onglet si cross-origin)
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.target = '_blank';
    link.rel = 'noopener';
    document.body.appendChild(link);
    link.click();
    link.remove();
    console.log(`T√©l√©chargement lanc√©: ${filename} depuis ${url}`);
}


// Navigation directe sur clic, plus de popup d'URL
document.addEventListener('DOMContentLoaded', function() {
    const links = document.querySelectorAll('.email-text a, .attachment-link');

    links.forEach(function(link) {
        // Info-bulle au survol
        link.addEventListener('mouseenter', function() {
            this.title = `Destination: ${this.href}`;
        });

        // Laisser la navigation par d√©faut (aucun preventDefault)

        // Indicateur visuel pour liens suspects
        const href = link.getAttribute('href');
        if (href && (href.includes('malicious') || href.includes('phishing') || href.includes('fake'))) {
            link.style.borderBottom = '2px solid #dc3545';
            link.title = 'Lien suspect d√©tect√© !';
        }
    });
});
</script>

<style>
.link-modal { /* plus utilis√©, conserv√© vide intentionnellement */ }

.modal-content {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    max-width: 600px;
    width: 90%;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}

.modal-content h3 {
    margin-bottom: 1rem;
    color: #333;
}

.modal-content p {
    margin-bottom: 1rem;
    line-height: 1.6;
}

.modal-content code {
    background: #f8f9fa;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    color: #dc3545;
}

.modal-actions {
    text-align: right;
    margin-top: 1.5rem;
}
</style>
{% endblock %}
